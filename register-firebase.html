<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إنشاء حساب - شارك سيارتك</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <i class="fas fa-car"></i>
                    <span>شارك سيارتك</span>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="login-firebase.html">تسجيل الدخول</a></li>
                    <li><a href="register-firebase.html" class="active">إنشاء حساب</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Register Section -->
    <section class="auth-section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-header">
                    <h1>إنشاء حساب جديد</h1>
                    <p>أدخل بياناتك لإنشاء حساب جديد</p>
                </div>

                <form id="registerForm" class="auth-form">
                    <div class="form-group">
                        <label for="fullName">
                            <i class="fas fa-user"></i>
                            الاسم الكامل
                        </label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>

                    <div class="form-group">
                        <label for="email">
                            <i class="fas fa-envelope"></i>
                            البريد الإلكتروني
                        </label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">
                            <i class="fas fa-phone"></i>
                            رقم الهاتف
                        </label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>

                    <div class="form-group">
                        <label for="city">
                            <i class="fas fa-map-marker-alt"></i>
                            المدينة
                        </label>
                        <select id="city" name="city" required>
                            <option value="">اختر المدينة</option>
                            <option value="الرياض">الرياض</option>
                            <option value="جدة">جدة</option>
                            <option value="الدمام">الدمام</option>
                            <option value="مكة المكرمة">مكة المكرمة</option>
                            <option value="المدينة المنورة">المدينة المنورة</option>
                            <option value="الطائف">الطائف</option>
                            <option value="تبوك">تبوك</option>
                            <option value="أبها">أبها</option>
                            <option value="حائل">حائل</option>
                            <option value="بريدة">بريدة</option>
                            <option value="خميس مشيط">خميس مشيط</option>
                            <option value="الظهران">الظهران</option>
                            <option value="الخبر">الخبر</option>
                            <option value="الجبيل">الجبيل</option>
                            <option value="ينبع">ينبع</option>
                            <option value="رابغ">رابغ</option>
                            <option value="القصيم">القصيم</option>
                            <option value="حفر الباطن">حفر الباطن</option>
                            <option value="القطيف">القطيف</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="userType">
                            <i class="fas fa-users"></i>
                            نوع الحساب
                        </label>
                        <div class="user-type-selection">
                            <label class="user-type-option">
                                <input type="radio" name="userType" value="renter" checked>
                                <div class="option-content">
                                    <i class="fas fa-user"></i>
                                    <span>مستأجر</span>
                                    <small>أريد استئجار سيارات</small>
                                </div>
                            </label>
                            <label class="user-type-option">
                                <input type="radio" name="userType" value="owner">
                                <div class="option-content">
                                    <i class="fas fa-car"></i>
                                    <span>صاحب سيارة</span>
                                    <small>أريد تأجير سياراتي</small>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            كلمة المرور
                        </label>
                        <div class="password-input">
                            <input type="password" id="password" name="password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">
                            <i class="fas fa-lock"></i>
                            تأكيد كلمة المرور
                        </label>
                        <div class="password-input">
                            <input type="password" id="confirmPassword" name="confirmPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreeTerms" required>
                            <span class="checkmark"></span>
                            أوافق على <a href="#" onclick="showTerms()">الشروط والأحكام</a>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-user-plus"></i>
                        إنشاء الحساب
                    </button>
                </form>

                <div class="auth-divider">
                    <span>أو</span>
                </div>

                <div class="social-login">
                    <button class="btn btn-google" onclick="signUpWithGoogle()">
                        <i class="fab fa-google"></i>
                        إنشاء حساب بـ Google
                    </button>
                </div>

                <div class="auth-footer">
                    <p>لديك حساب بالفعل؟ <a href="login-firebase.html">تسجيل الدخول</a></p>
                </div>

                <!-- Message Container -->
                <div id="messageContainer" class="message-container" style="display: none;">
                    <div class="message-content">
                        <i class="message-icon"></i>
                        <span class="message-text"></span>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="loading-content">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري إنشاء الحساب...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Service -->
    <script src="firebase-service.js"></script>
    
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupFormListeners();
            checkAuthState();
        });

        // Setup form listeners
        function setupFormListeners() {
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        // Check authentication state
        function checkAuthState() {
            if (firebaseService.isAuthenticated()) {
                redirectBasedOnUserType();
            }
        }

        // Handle register form submission
        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                full_name: formData.get('fullName').trim(),
                email: formData.get('email').trim(),
                phone: formData.get('phone').trim(),
                city: formData.get('city'),
                user_type: formData.get('userType'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword')
            };

            // Validation
            if (!validateForm(userData)) {
                return;
            }

            // Show loading
            showLoading(true);

            try {
                // Register with Firebase
                const result = await firebaseService.registerUser(userData);
                
                if (result && result.user && result.profile) {
                    showMessage('تم إنشاء الحساب بنجاح', 'success');
                    
                    // Store user info in session storage
                    sessionStorage.setItem('currentUser', JSON.stringify({
                        uid: result.user.uid,
                        email: result.profile.email,
                        full_name: result.profile.full_name,
                        user_type: result.profile.user_type
                    }));

                    // Redirect based on user type
                    setTimeout(() => {
                        redirectBasedOnUserType();
                    }, 1000);

                } else {
                    showMessage('فشل في إنشاء الحساب', 'error');
                }

            } catch (error) {
                console.error('Registration error:', error);
                
                let errorMessage = 'حدث خطأ في إنشاء الحساب';
                
                // Handle specific Firebase auth errors
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صحيح';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'كلمة المرور ضعيفة جداً';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'إنشاء الحساب غير مسموح حالياً';
                        break;
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Validate form data
        function validateForm(userData) {
            // Check required fields
            if (!userData.full_name || !userData.email || !userData.phone || 
                !userData.city || !userData.password || !userData.confirmPassword) {
                showMessage('يرجى ملء جميع الحقول المطلوبة', 'error');
                return false;
            }

            // Validate email
            if (!isValidEmail(userData.email)) {
                showMessage('يرجى إدخال بريد إلكتروني صحيح', 'error');
                return false;
            }

            // Validate phone
            if (!isValidPhone(userData.phone)) {
                showMessage('يرجى إدخال رقم هاتف صحيح', 'error');
                return false;
            }

            // Validate password
            if (userData.password.length < 6) {
                showMessage('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return false;
            }

            // Check password confirmation
            if (userData.password !== userData.confirmPassword) {
                showMessage('كلمة المرور وتأكيدها غير متطابقين', 'error');
                return false;
            }

            // Check terms agreement
            if (!document.getElementById('agreeTerms').checked) {
                showMessage('يجب الموافقة على الشروط والأحكام', 'error');
                return false;
            }

            return true;
        }

        // Sign up with Google
        async function signUpWithGoogle() {
            try {
                showLoading(true);
                
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                
                if (result.user) {
                    // Check if user already exists
                    const userProfile = await firebaseService.getCurrentUserProfile();
                    
                    if (userProfile) {
                        showMessage('هذا الحساب مسجل بالفعل', 'error');
                        return;
                    }

                    // Create user profile for new Google user
                    const userData = {
                        uid: result.user.uid,
                        email: result.user.email,
                        full_name: result.user.displayName || 'مستخدم Google',
                        phone: result.user.phoneNumber || '',
                        city: '',
                        user_type: 'renter', // Default to renter
                        profile_photo: result.user.photoURL || null,
                        created_at: new Date().toISOString(),
                        is_active: true
                    };
                    
                    await firebaseService.db.ref(`users/${result.user.uid}`).set(userData);
                    
                    showMessage('تم إنشاء الحساب بنجاح', 'success');
                    
                    // Store user info
                    sessionStorage.setItem('currentUser', JSON.stringify({
                        uid: result.user.uid,
                        email: result.user.email,
                        full_name: result.user.displayName || 'مستخدم Google',
                        user_type: 'renter'
                    }));

                    setTimeout(() => {
                        redirectBasedOnUserType();
                    }, 1000);
                }

            } catch (error) {
                console.error('Google sign-up error:', error);
                showMessage('فشل في إنشاء الحساب بـ Google', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Redirect based on user type
        async function redirectBasedOnUserType() {
            try {
                const userType = await firebaseService.getUserType();
                
                if (userType === 'owner') {
                    window.location.href = 'dashboard.html';
                } else {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error getting user type:', error);
                // Default redirect
                window.location.href = 'index.html';
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggleBtn = input.parentNode.querySelector('.password-toggle i');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggleBtn.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                toggleBtn.className = 'fas fa-eye';
            }
        }

        // Validate email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Validate phone
        function isValidPhone(phone) {
            const phoneRegex = /^[0-9+\-\s()]{10,}$/;
            return phoneRegex.test(phone);
        }

        // Show terms and conditions
        function showTerms() {
            alert('الشروط والأحكام:\n\n1. يجب أن تكون عمرك 18 عاماً أو أكثر\n2. يجب أن تمتلك رخصة قيادة سارية\n3. يجب الالتزام بقوانين المرور\n4. يحظر استخدام الموقع لأي أغراض غير مشروعة\n5. نحتفظ بحق تعديل هذه الشروط في أي وقت');
        }

        // Show message
        function showMessage(message, type) {
            const messageContainer = document.getElementById('messageContainer');
            const messageText = messageContainer.querySelector('.message-text');
            const messageIcon = messageContainer.querySelector('.message-icon');
            
            messageText.textContent = message;
            
            // Set icon and class based on type
            messageContainer.className = `message-container ${type}`;
            
            switch (type) {
                case 'success':
                    messageIcon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    messageIcon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    messageIcon.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    messageIcon.className = 'fas fa-info-circle';
            }
            
            messageContainer.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        // Show/hide loading
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
    </script>

    <style>
        .user-type-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .user-type-option {
            cursor: pointer;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .user-type-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .user-type-option input[type="radio"] {
            display: none;
        }

        .user-type-option input[type="radio"]:checked + .option-content {
            color: #3b82f6;
        }

        .user-type-option input[type="radio"]:checked {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .option-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .option-content i {
            font-size: 1.5rem;
            color: #6b7280;
        }

        .option-content span {
            font-weight: 600;
            color: #374151;
        }

        .option-content small {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .user-type-option input[type="radio"]:checked + .option-content i,
        .user-type-option input[type="radio"]:checked + .option-content span {
            color: #3b82f6;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .loading-content i {
            font-size: 2rem;
            color: #3b82f6;
            margin-bottom: 15px;
        }

        .loading-content p {
            color: #6b7280;
            margin: 0;
        }

        .social-login {
            margin: 20px 0;
        }

        .btn-google {
            background: #4285f4;
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-google:hover {
            background: #3367d6;
        }

        .btn-google i {
            margin-left: 10px;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
        }

        .auth-divider span {
            background: white;
            padding: 0 15px;
            color: #6b7280;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .user-type-selection {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>

