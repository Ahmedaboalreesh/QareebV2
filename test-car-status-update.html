<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار تحديث حالة السيارة - شارك سيارتك</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <i class="fas fa-car"></i>
                    <span>شارك سيارتك</span>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="test-car-status-update.html" class="active">اختبار حالة السيارة</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Test Section -->
    <section class="test-section">
        <div class="container">
            <div class="test-header">
                <h1>اختبار تحديث حالة السيارة</h1>
                <p>اختبار أن السيارة تعود للظهور في صفحة تصفح السيارات بعد إكمال الحجز</p>
            </div>

            <!-- Test Controls -->
            <div class="test-controls">
                <div class="test-card">
                    <h3>1. إعداد البيانات التجريبية</h3>
                    <button class="btn btn-primary" onclick="setupTestData()">
                        <i class="fas fa-database"></i>
                        إنشاء بيانات تجريبية
                    </button>
                    <p>إنشاء سيارة وحجز تجريبي</p>
                </div>

                <div class="test-card">
                    <h3>2. محاكاة موافقة صاحب السيارة</h3>
                    <button class="btn btn-success" onclick="simulateOwnerApproval()">
                        <i class="fas fa-check-circle"></i>
                        محاكاة الموافقة
                    </button>
                    <p>تحديث حالة الحجز إلى "موافق عليها"</p>
                </div>

                <div class="test-card">
                    <h3>3. محاكاة إكمال الحجز</h3>
                    <button class="btn btn-info" onclick="simulateBookingCompletion()">
                        <i class="fas fa-calendar-check"></i>
                        محاكاة إكمال الحجز
                    </button>
                    <p>تحديث حالة الحجز إلى "مكتمل"</p>
                </div>

                <div class="test-card">
                    <h3>4. فحص صفحة تصفح السيارات</h3>
                    <button class="btn btn-warning" onclick="checkBrowseCars()">
                        <i class="fas fa-eye"></i>
                        فتح صفحة تصفح السيارات
                    </button>
                    <p>التحقق من ظهور السيارة مرة أخرى</p>
                </div>

                <div class="test-card">
                    <h3>5. إعادة تعيين البيانات</h3>
                    <button class="btn btn-danger" onclick="resetTestData()">
                        <i class="fas fa-undo"></i>
                        إعادة تعيين
                    </button>
                    <p>مسح جميع البيانات التجريبية</p>
                </div>
            </div>

            <!-- Test Results -->
            <div class="test-results">
                <h3>نتائج الاختبار</h3>
                <div id="testResults" class="results-container">
                    <p>لم يتم تشغيل أي اختبار بعد</p>
                </div>
            </div>

            <!-- Current Data Display -->
            <div class="current-data">
                <h3>البيانات الحالية</h3>
                <div class="data-display">
                    <div class="data-section">
                        <h4>السيارات</h4>
                        <pre id="currentCars">غير محدد</pre>
                    </div>
                    <div class="data-section">
                        <h4>الحجوزات</h4>
                        <pre id="currentBookings">غير محدد</pre>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Test functions
        function setupTestData() {
            try {
                // Create test car
                const testCar = {
                    id: 1,
                    brand: 'تويوتا',
                    model: 'كامري',
                    year: '2023',
                    daily_rate: 150,
                    location: 'الرياض',
                    transmission: 'أوتوماتيك',
                    fuel_type: 'بنزين',
                    mileage: 25000,
                    rating: 4.8,
                    photos: ['car1.jpg'],
                    features: ['ac', 'bluetooth', 'gps'],
                    status: 'active',
                    available: true,
                    owner_id: 1,
                    owner_name: 'أحمد المالك'
                };

                // Create test booking
                const testBooking = {
                    id: 1,
                    car_id: 1,
                    renter_id: 2,
                    car_name: 'تويوتا كامري 2023',
                    car_brand: 'تويوتا',
                    car_model: 'كامري',
                    car_year: '2023',
                    start_date: '2024-02-15',
                    end_date: '2024-02-18',
                    total_amount: 450,
                    deposit_amount: 500,
                    status: 'pending',
                    pickup_location: 'مطار الملك خالد الدولي',
                    return_location: 'مطار الملك خالد الدولي',
                    renter_notes: 'حجز تجريبي للاختبار',
                    created_at: new Date().toISOString(),
                    owner_name: 'أحمد المالك',
                    owner_phone: '+966501234567'
                };

                // Save to localStorage
                localStorage.setItem('mockCars', JSON.stringify([testCar]));
                localStorage.setItem('mockBookings', JSON.stringify([testBooking]));

                updateTestResults('✅ تم إنشاء البيانات التجريبية بنجاح', 'success');
                updateCurrentData();
                
            } catch (error) {
                updateTestResults('❌ خطأ في إنشاء البيانات التجريبية: ' + error.message, 'error');
            }
        }

        function simulateOwnerApproval() {
            try {
                const bookings = JSON.parse(localStorage.getItem('mockBookings') || '[]');
                const booking = bookings.find(b => b.id === 1);
                
                if (booking) {
                    booking.status = 'approved';
                    booking.updated_at = new Date().toISOString();
                    localStorage.setItem('mockBookings', JSON.stringify(bookings));
                    
                    // Update car status to booked
                    const cars = JSON.parse(localStorage.getItem('mockCars') || '[]');
                    const car = cars.find(c => c.id === 1);
                    if (car) {
                        car.status = 'booked';
                        car.available = false;
                        localStorage.setItem('mockCars', JSON.stringify(cars));
                    }
                    
                    updateTestResults('✅ تم تحديث حالة الحجز إلى "موافق عليها" والسيارة أصبحت محجوزة', 'success');
                    updateCurrentData();
                } else {
                    updateTestResults('❌ لم يتم العثور على الحجز التجريبي', 'error');
                }
            } catch (error) {
                updateTestResults('❌ خطأ في تحديث حالة الحجز: ' + error.message, 'error');
            }
        }

        function simulateBookingCompletion() {
            try {
                const bookings = JSON.parse(localStorage.getItem('mockBookings') || '[]');
                const booking = bookings.find(b => b.id === 1);
                
                if (booking) {
                    booking.status = 'completed';
                    booking.updated_at = new Date().toISOString();
                    localStorage.setItem('mockBookings', JSON.stringify(bookings));
                    
                    // Update car status to active (available)
                    const cars = JSON.parse(localStorage.getItem('mockCars') || '[]');
                    const car = cars.find(c => c.id === 1);
                    if (car) {
                        car.status = 'active';
                        car.available = true;
                        localStorage.setItem('mockCars', JSON.stringify(cars));
                    }
                    
                    updateTestResults('✅ تم تحديث حالة الحجز إلى "مكتمل" والسيارة أصبحت متاحة مرة أخرى', 'success');
                    updateCurrentData();
                } else {
                    updateTestResults('❌ لم يتم العثور على الحجز التجريبي', 'error');
                }
            } catch (error) {
                updateTestResults('❌ خطأ في تحديث حالة الحجز: ' + error.message, 'error');
            }
        }

        function checkBrowseCars() {
            // Open browse-cars page in new tab
            window.open('browse-cars.html', '_blank');
            updateTestResults('🔗 تم فتح صفحة تصفح السيارات في تبويب جديد', 'info');
        }

        function resetTestData() {
            try {
                // Clear test data
                localStorage.removeItem('mockCars');
                localStorage.removeItem('mockBookings');
                
                updateTestResults('🔄 تم إعادة تعيين البيانات التجريبية', 'warning');
                updateCurrentData();
            } catch (error) {
                updateTestResults('❌ خطأ في إعادة تعيين البيانات: ' + error.message, 'error');
            }
        }

        function updateTestResults(message, type) {
            const resultsContainer = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${type}`;
            resultElement.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <span class="message">${message}</span>
            `;
            
            resultsContainer.appendChild(resultElement);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        function updateCurrentData() {
            try {
                const carsData = localStorage.getItem('mockCars');
                const bookingsData = localStorage.getItem('mockBookings');
                
                document.getElementById('currentCars').textContent = carsData ? JSON.stringify(JSON.parse(carsData), null, 2) : 'غير محدد';
                document.getElementById('currentBookings').textContent = bookingsData ? JSON.stringify(JSON.parse(bookingsData), null, 2) : 'غير محدد';
            } catch (error) {
                console.error('Error updating current data:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentData();
        });
    </script>

    <style>
        .test-section {
            padding: 120px 0 60px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .test-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .test-header h1 {
            color: #1f2937;
            margin-bottom: 10px;
        }

        .test-header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .test-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .test-card h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }

        .test-card p {
            color: #6b7280;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .test-results {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .test-results h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }

        .results-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: #f9fafb;
        }

        .test-result {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .test-result:last-child {
            border-bottom: none;
        }

        .test-result .timestamp {
            color: #6b7280;
            font-size: 0.8rem;
            min-width: 80px;
        }

        .test-result.success .message {
            color: #059669;
        }

        .test-result.error .message {
            color: #dc2626;
        }

        .test-result.warning .message {
            color: #d97706;
        }

        .test-result.info .message {
            color: #2563eb;
        }

        .current-data {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .current-data h3 {
            color: #1f2937;
            margin-bottom: 15px;
        }

        .data-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .data-section h4 {
            color: #374151;
            margin-bottom: 10px;
        }

        .data-section pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.8rem;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .test-controls {
                grid-template-columns: 1fr;
            }
            
            .data-display {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
