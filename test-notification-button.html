<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        /* Override notification dropdown positioning for test page */
        .notifications-dropdown {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
        }
        
        @media (max-width: 768px) {
            .notifications-dropdown {
                width: 350px !important;
                right: 10px !important;
                top: 70px !important;
            }
        }
        
        @media (max-width: 480px) {
            .notifications-dropdown {
                width: calc(100vw - 20px) !important;
                right: 10px !important;
                left: 10px !important;
                top: 65px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
        
        <div class="test-section">
            <h3>1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <button class="btn" onclick="setupTestData()">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            <button class="btn" onclick="showDebugInfo()">Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­</button>
            <div id="debugInfo" class="debug-info"></div>
        </div>

        <div class="test-section">
            <h3>2. Ø§Ø®ØªØ¨Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¸ÙŠÙØªÙ‡:</p>
            
            <!-- Header with notification button -->
            <header class="header">
                <nav class="navbar">
                    <div class="nav-container">
                        <div class="nav-logo">
                            <i class="fas fa-car"></i>
                            <span>Ø´Ø§Ø±Ùƒ Ø³ÙŠØ§Ø±ØªÙƒ</span>
                        </div>
                        <div class="nav-buttons">
                            <button class="btn btn-outline notification-btn" onclick="toggleNotifications()" id="notificationBtn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- Notifications Dropdown -->
            <div class="notifications-dropdown" id="notificationsDropdown" style="display: none;">
                <div class="notifications-header">
                    <h3><i class="fas fa-bell"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                    <div class="notifications-actions">
                        <button class="btn btn-outline btn-sm" onclick="markAllAsRead()">
                            <i class="fas fa-check-double"></i>
                            ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="clearAllNotifications()">
                            <i class="fas fa-trash"></i>
                            Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                        </button>
                    </div>
                </div>
                
                <div class="notifications-container" id="notificationsContainer">
                    <!-- Notifications will be loaded here -->
                </div>
                
                <div class="no-notifications" id="noNotifications" style="display: none;">
                    <div class="no-notifications-icon">
                        <i class="far fa-bell-slash"></i>
                    </div>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h3>
                    <p>Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ù‡Ø§</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>3. Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</h3>
            <button class="btn" onclick="createTestNotification()">Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
            <button class="btn" onclick="createMultipleNotifications()">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <button class="btn" onclick="clearAllNotifications()">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        </div>

        <div class="test-section">
            <h3>4. Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
            <button class="btn" onclick="window.open('renter-dashboard.html', '_blank')">ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button class="btn" onclick="window.open('test-notifications.html', '_blank')">ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        </div>
    </div>

    <script>
        // Setup test data
        function setupTestData() {
            const testUserData = {
                id: 'test-renter-' + Date.now(),
                full_name: 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ',
                email: 'test@example.com'
            };
            
            localStorage.setItem('userData', JSON.stringify(testUserData));
            localStorage.setItem('userToken', 'test-token-' + Date.now());
            localStorage.setItem('userType', 'renter');
            
            // Create some sample notifications
            const sampleNotifications = [
                {
                    id: 'test-1',
                    user_id: testUserData.id,
                    type: 'success',
                    title: 'ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                    message: 'ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.',
                    link: null,
                    read: false,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'test-2',
                    user_id: testUserData.id,
                    type: 'warning',
                    title: 'ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…',
                    message: 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.',
                    link: null,
                    read: false,
                    created_at: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('notifications', JSON.stringify(sampleNotifications));
            
            alert('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!');
            showDebugInfo();
        }

        // Show debug information
        function showDebugInfo() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const userToken = localStorage.getItem('userToken');
            const userType = localStorage.getItem('userType');
            
            const debugInfo = `
User Data: ${JSON.stringify(userData, null, 2)}
User Token: ${userToken}
User Type: ${userType}
Total Notifications: ${notifications.length}
User Notifications: ${notifications.filter(n => n.user_id === userData.id || n.user_id === 'all').length}
            `;
            
            document.getElementById('debugInfo').textContent = debugInfo;
        }

        // Create test notification
        function createTestNotification() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            const newNotification = {
                id: 'test-' + Date.now(),
                user_id: userData.id,
                type: 'info',
                title: 'Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
                message: 'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.',
                link: null,
                read: false,
                created_at: new Date().toISOString()
            };
            
            notifications.push(newNotification);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update notification badge
            loadNotifications();
            
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
        }

        // Create multiple notifications
        function createMultipleNotifications() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            
            const newNotifications = [
                {
                    id: 'multi-1-' + Date.now(),
                    user_id: userData.id,
                    type: 'success',
                    title: 'Ø¥Ø´Ø¹Ø§Ø± Ù†Ø¬Ø§Ø­',
                    message: 'ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.',
                    link: null,
                    read: false,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'multi-2-' + Date.now(),
                    user_id: userData.id,
                    type: 'warning',
                    title: 'Ø¥Ø´Ø¹Ø§Ø± ØªØ­Ø°ÙŠØ±',
                    message: 'ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….',
                    link: null,
                    read: false,
                    created_at: new Date().toISOString()
                },
                {
                    id: 'multi-3-' + Date.now(),
                    user_id: userData.id,
                    type: 'info',
                    title: 'Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
                    message: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…ØªØ§Ø­Ø©.',
                    link: null,
                    read: false,
                    created_at: new Date().toISOString()
                }
            ];
            
            notifications.push(...newNotifications);
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update notification badge
            loadNotifications();
            
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 3 Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            console.log('ğŸ”” Toggle notifications called');
            
            const dropdown = document.getElementById('notificationsDropdown');
            const notificationBtn = document.getElementById('notificationBtn');
            
            console.log('ğŸ” Dropdown element:', dropdown);
            console.log('ğŸ” Notification button:', notificationBtn);
            
            if (dropdown) {
                const currentDisplay = dropdown.style.display;
                console.log('ğŸ” Current dropdown display:', currentDisplay);
                
                if (currentDisplay === 'none' || currentDisplay === '') {
                    dropdown.style.display = 'block';
                    loadNotifications(); // Refresh notifications when opening
                    console.log('âœ… Notifications dropdown opened');
                } else {
                    dropdown.style.display = 'none';
                    console.log('âœ… Notifications dropdown closed');
                }
            } else {
                console.error('âŒ Notifications dropdown element not found');
            }
        }

        // Load notifications
        function loadNotifications() {
            try {
                console.log('ğŸ” Loading notifications...');
                
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                
                console.log('ğŸ” All notifications:', notifications);
                console.log('ğŸ” User data:', userData);
                
                // Filter notifications for current user
                const userNotifications = notifications.filter(notification => 
                    notification.user_id === userData.id || notification.user_id === 'all'
                );
                
                console.log('ğŸ” User notifications:', userNotifications);
                
                displayNotifications(userNotifications);
                updateNotificationBadge(userNotifications);
                
                console.log('âœ… Notifications loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading notifications:', error);
                displayNotifications([]);
                updateNotificationBadge([]);
            }
        }

        // Update notification badge
        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Display notifications
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationsContainer');
            const noNotifications = document.getElementById('noNotifications');
            
            if (!container) return;
            
            if (notifications.length === 0) {
                container.innerHTML = '';
                if (noNotifications) {
                    noNotifications.style.display = 'block';
                }
                return;
            }
            
            if (noNotifications) {
                noNotifications.style.display = 'none';
            }
            
            // Sort notifications by date (newest first)
            notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            container.innerHTML = notifications.map(notification => createNotificationItem(notification)).join('');
        }

        // Create notification item
        function createNotificationItem(notification) {
            const isUnread = !notification.read;
            const iconClass = getNotificationIconClass(notification.type);
            const timeAgo = getTimeAgo(notification.created_at);
            
            return `
                <div class="notification-item ${isUnread ? 'unread' : ''}" data-notification-id="${notification.id}">
                    <div class="notification-icon ${notification.type}">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-meta">
                            <span class="notification-time">${timeAgo}</span>
                            <div class="notification-actions">
                                ${notification.link ? `
                                    <button class="btn-view" onclick="viewNotification('${notification.link}')">
                                        <i class="fas fa-eye"></i>
                                        Ø¹Ø±Ø¶
                                    </button>
                                ` : ''}
                                ${isUnread ? `
                                    <button class="btn-mark-read" onclick="markAsRead(${notification.id})">
                                        <i class="fas fa-check"></i>
                                        Ù…Ù‚Ø±ÙˆØ¡
                                    </button>
                                ` : ''}
                                <button class="btn-delete" onclick="deleteNotification(${notification.id})">
                                    <i class="fas fa-trash"></i>
                                    Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get notification icon class
        function getNotificationIconClass(type) {
            const iconMap = {
                'success': 'fas fa-check-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-triangle',
                'error': 'fas fa-times-circle',
                'booking': 'fas fa-calendar-check',
                'payment': 'fas fa-credit-card',
                'car': 'fas fa-car',
                'system': 'fas fa-cog'
            };
            
            return iconMap[type] || 'fas fa-bell';
        }

        // Get time ago
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Ø§Ù„Ø¢Ù†';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            } else if (diffInSeconds < 2592000) {
                const days = Math.floor(diffInSeconds / 86400);
                return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
            } else {
                return date.toLocaleDateString('ar-SA');
            }
        }

        // Mark as read
        function markAsRead(notificationId) {
            try {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const notification = notifications.find(n => n.id === notificationId);
                
                if (notification) {
                    notification.read = true;
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    
                    // Update UI
                    const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationElement) {
                        notificationElement.classList.remove('unread');
                        const markReadBtn = notificationElement.querySelector('.btn-mark-read');
                        if (markReadBtn) {
                            markReadBtn.remove();
                        }
                    }
                    
                    // Update badge
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Delete notification
        function deleteNotification(notificationId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ')) {
                try {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const updatedNotifications = notifications.filter(n => n.id !== notificationId);
                    
                    localStorage.setItem('notifications', JSON.stringify(updatedNotifications));
                    
                    // Remove from UI
                    const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationElement) {
                        notificationElement.remove();
                    }
                    
                    // Update badge
                    loadNotifications();
                } catch (error) {
                    console.error('Error deleting notification:', error);
                }
            }
        }

        // Mark all as read
        function markAllAsRead() {
            try {
                const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                
                notifications.forEach(notification => {
                    if (notification.user_id === userData.id || notification.user_id === 'all') {
                        notification.read = true;
                    }
                });
                
                localStorage.setItem('notifications', JSON.stringify(notifications));
                loadNotifications();
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) {
                try {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    
                    const updatedNotifications = notifications.filter(notification => 
                        notification.user_id !== userData.id && notification.user_id !== 'all'
                    );
                    
                    localStorage.setItem('notifications', JSON.stringify(updatedNotifications));
                    loadNotifications();
                } catch (error) {
                    console.error('Error clearing notifications:', error);
                }
            }
        }

        // View notification
        function viewNotification(link) {
            if (link) {
                window.location.href = link;
            }
        }

        // Setup notification dropdown
        function setupNotificationDropdown() {
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('notificationsDropdown');
                const notificationBtn = document.getElementById('notificationBtn');
                
                if (dropdown && notificationBtn) {
                    if (!dropdown.contains(event.target) && !notificationBtn.contains(event.target)) {
                        dropdown.style.display = 'none';
                    }
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” Initializing test page...');
            
            // Setup notification dropdown
            setupNotificationDropdown();
            
            // Show debug info
            showDebugInfo();
            
            console.log('âœ… Test page initialized');
        });
    </script>
</body>
</html>
