const db = require('./database/firebase-db');

async function testNotificationIntegration() {
    console.log('üîî Testing Notification Integration with Photo Upload...\n');

    try {
        // Test 1: Create mock users
        console.log('1Ô∏è‚É£ Creating mock users...');
        const mockOwner = {
            id: 'test-owner-' + Date.now(),
            full_name: 'ŸÖÿßŸÑŸÉ ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä',
            email: 'owner@test.com',
            phone: '+966501234567',
            city: 'ÿßŸÑÿ±Ÿäÿßÿ∂'
        };

        const mockRenter = {
            id: 'test-renter-' + Date.now(),
            full_name: 'ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ± ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä',
            email: 'renter@test.com',
            phone: '+966507654321',
            city: 'ÿßŸÑÿ±Ÿäÿßÿ∂'
        };

        // Save users to database
        await db.createUser(mockOwner);
        await db.createUser(mockRenter);
        console.log('‚úÖ Mock users created');

        // Test 2: Create mock car
        console.log('\n2Ô∏è‚É£ Creating mock car...');
        const mockCar = {
            user_id: mockOwner.id,
            brand: 'ÿ™ŸàŸäŸàÿ™ÿß',
            model: 'ŸÉÿßŸÖÿ±Ÿä',
            year: 2023,
            color: 'ÿ£ÿ®Ÿäÿ∂',
            type: 'ÿ≥ŸäÿØÿßŸÜ',
            transmission: 'ÿ£Ÿàÿ™ŸàŸÖÿßÿ™ŸäŸÉ',
            fuel_type: 'ÿ®ŸÜÿ≤ŸäŸÜ',
            mileage: 50000,
            daily_rate: 200,
            weekly_rate: 1200,
            monthly_rate: 4500,
            deposit: 1000,
            available_from: '2024-01-01',
            available_to: '2024-12-31',
            location: 'ÿßŸÑÿ±Ÿäÿßÿ∂',
            pickup_location: 'ŸÖÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÉ ÿÆÿßŸÑÿØ ÿßŸÑÿØŸàŸÑŸä',
            description: 'ÿ≥Ÿäÿßÿ±ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
            features: ['ŸÖŸÉŸäŸÅ', 'GPS', 'ÿ®ŸÑŸàÿ™Ÿàÿ´']
        };

        const createdCar = await db.createCar(mockCar);
        console.log('‚úÖ Mock car created:', createdCar.id);

        // Test 3: Create mock booking
        console.log('\n3Ô∏è‚É£ Creating mock booking...');
        const mockBooking = {
            car_id: createdCar.id,
            renter_id: mockRenter.id,
            start_date: '2024-02-01',
            end_date: '2024-02-03',
            total_amount: 400,
            deposit_amount: 1000,
            pickup_location: 'ŸÖÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÉ ÿÆÿßŸÑÿØ ÿßŸÑÿØŸàŸÑŸä',
            return_location: 'ŸÖÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÉ ÿÆÿßŸÑÿØ ÿßŸÑÿØŸàŸÑŸä',
            renter_notes: 'ÿ≠ÿ¨ÿ≤ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±'
        };

        const createdBooking = await db.createBooking(mockBooking);
        console.log('‚úÖ Mock booking created:', createdBooking.id);

        // Test 4: Update booking status to approved
        console.log('\n4Ô∏è‚É£ Updating booking status to approved...');
        await db.updateBookingStatus(createdBooking.id, 'approved', 'ÿ™ŸÖÿ™ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿä');
        console.log('‚úÖ Booking status updated to approved');

        // Test 5: Simulate photo upload and notification creation
        console.log('\n5Ô∏è‚É£ Testing photo upload notification...');
        const mockPhoto = {
            id: 'photo-' + Date.now(),
            booking_id: createdBooking.id,
            file_name: 'booking_photos/' + createdBooking.id + '/test_photo.jpg',
            download_url: 'https://via.placeholder.com/300x200/007bff/ffffff?text=ÿµŸàÿ±ÿ©+ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ©',
            description: 'ÿµŸàÿ±ÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±',
            photo_type: 'general',
            uploaded_by: 'renter',
            created_at: new Date().toISOString()
        };

        // This should trigger notification creation
        await db.createPhotoUploadNotification(createdBooking.id, mockPhoto);
        console.log('‚úÖ Photo upload notification created');

        // Test 6: Verify notification was created for car owner
        console.log('\n6Ô∏è‚É£ Verifying notification for car owner...');
        const ownerNotifications = await db.getNotificationsByUserId(mockOwner.id, 10);
        const photoUploadNotifications = ownerNotifications.filter(n => n.type === 'photo_uploaded');

        if (photoUploadNotifications.length > 0) {
            console.log('‚úÖ Photo upload notification found for car owner');
            console.log('üìã Notification details:', {
                id: photoUploadNotifications[0].id,
                title: photoUploadNotifications[0].title,
                description: photoUploadNotifications[0].description,
                is_read: photoUploadNotifications[0].is_read
            });
        } else {
            console.log('‚ùå No photo upload notification found for car owner');
        }

        // Test 7: Test notification management
        console.log('\n7Ô∏è‚É£ Testing notification management...');
        
        // Get unread count
        const unreadCount = await db.getUnreadNotificationsCount(mockOwner.id);
        console.log(`üìä Unread notifications count: ${unreadCount}`);

        // Mark notification as read
        if (photoUploadNotifications.length > 0) {
            await db.markNotificationAsRead(photoUploadNotifications[0].id);
            console.log('‚úÖ Notification marked as read');

            // Verify unread count decreased
            const newUnreadCount = await db.getUnreadNotificationsCount(mockOwner.id);
            console.log(`üìä New unread count: ${newUnreadCount}`);
        }

        // Test 8: Create multiple photo uploads
        console.log('\n8Ô∏è‚É£ Testing multiple photo uploads...');
        const additionalPhotos = [
            {
                id: 'photo-exterior-' + Date.now(),
                booking_id: createdBooking.id,
                file_name: 'booking_photos/' + createdBooking.id + '/exterior_photo.jpg',
                download_url: 'https://via.placeholder.com/300x200/28a745/ffffff?text=ÿµŸàÿ±ÿ©+ÿÆÿßÿ±ÿ¨Ÿäÿ©',
                description: 'ÿµŸàÿ±ÿ© ÿÆÿßÿ±ÿ¨Ÿäÿ© ŸÑŸÑÿ≥Ÿäÿßÿ±ÿ©',
                photo_type: 'exterior',
                uploaded_by: 'renter',
                created_at: new Date().toISOString()
            },
            {
                id: 'photo-interior-' + Date.now(),
                booking_id: createdBooking.id,
                file_name: 'booking_photos/' + createdBooking.id + '/interior_photo.jpg',
                download_url: 'https://via.placeholder.com/300x200/ffc107/ffffff?text=ÿµŸàÿ±ÿ©+ÿØÿßÿÆŸÑŸäÿ©',
                description: 'ÿµŸàÿ±ÿ© ÿØÿßÿÆŸÑŸäÿ© ŸÑŸÑÿ≥Ÿäÿßÿ±ÿ©',
                photo_type: 'interior',
                uploaded_by: 'renter',
                created_at: new Date().toISOString()
            }
        ];

        for (const photo of additionalPhotos) {
            await db.createPhotoUploadNotification(createdBooking.id, photo);
        }
        console.log('‚úÖ Multiple photo upload notifications created');

        // Test 9: Verify all notifications
        console.log('\n9Ô∏è‚É£ Verifying all notifications...');
        const allOwnerNotifications = await db.getNotificationsByUserId(mockOwner.id, 20);
        const photoNotifications = allOwnerNotifications.filter(n => n.type === 'photo_uploaded');
        
        console.log(`üìä Total notifications for owner: ${allOwnerNotifications.length}`);
        console.log(`üì∑ Photo upload notifications: ${photoNotifications.length}`);

        // Test 10: Test notification types and content
        console.log('\nüîü Testing notification content...');
        photoNotifications.forEach((notification, index) => {
            console.log(`üìã Notification ${index + 1}:`);
            console.log(`   - Title: ${notification.title}`);
            console.log(`   - Description: ${notification.description}`);
            console.log(`   - Type: ${notification.type}`);
            console.log(`   - Related ID: ${notification.related_id}`);
            console.log(`   - Is Read: ${notification.is_read}`);
        });

        // Test 11: Test notification for different user (renter should not get photo upload notifications)
        console.log('\n1Ô∏è‚É£1Ô∏è‚É£ Testing notifications for renter...');
        const renterNotifications = await db.getNotificationsByUserId(mockRenter.id, 10);
        const renterPhotoNotifications = renterNotifications.filter(n => n.type === 'photo_uploaded');
        
        console.log(`üìä Total notifications for renter: ${renterNotifications.length}`);
        console.log(`üì∑ Photo upload notifications for renter: ${renterPhotoNotifications.length}`);
        
        if (renterPhotoNotifications.length === 0) {
            console.log('‚úÖ Correct: Renter does not receive photo upload notifications');
        } else {
            console.log('‚ùå Error: Renter should not receive photo upload notifications');
        }

        console.log('\nüéâ Notification integration test completed successfully!');
        console.log('\nüìä Test Summary:');
        console.log(`   - Created ${mockOwner.full_name} (Owner)`);
        console.log(`   - Created ${mockRenter.full_name} (Renter)`);
        console.log(`   - Created car: ${mockCar.brand} ${mockCar.model} ${mockCar.year}`);
        console.log(`   - Created booking: ${createdBooking.id}`);
        console.log(`   - Created ${photoNotifications.length} photo upload notifications`);
        console.log(`   - Owner notifications: ${allOwnerNotifications.length}`);
        console.log(`   - Renter notifications: ${renterNotifications.length}`);

    } catch (error) {
        console.error('‚ùå Notification integration test failed:', error);
        console.error('Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
    }
}

// Run the integration test
testNotificationIntegration().then(() => {
    console.log('\nüèÅ Notification integration test finished');
    process.exit(0);
}).catch(error => {
    console.error('üí• Integration test failed:', error);
    process.exit(1);
});
