<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار شارة الإشعارات - منصة تأجير السيارات</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <i class="fas fa-car"></i>
                        <span>منصة تأجير السيارات</span>
                    </a>
                </div>
                <nav class="nav">
                    <a href="notifications.html" class="notification-link">
                        <i class="fas fa-bell"></i>
                        الإشعارات
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </a>
                    <a href="index.html">
                        <i class="fas fa-home"></i>
                        الرئيسية
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <section class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>
                    <i class="fas fa-bug"></i>
                    اختبار شارة الإشعارات
                </h1>
                <p>صفحة لاختبار وتصحيح مشكلة شارة الإشعارات</p>
            </div>

            <!-- Debug Information -->
            <div class="debug-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-info-circle"></i>
                        معلومات التصحيح
                    </h2>
                </div>
                
                <div class="debug-content">
                    <div class="debug-section">
                        <h3>معلومات المستخدم الحالي:</h3>
                        <div id="userInfo">
                            <p>جاري تحميل المعلومات...</p>
                        </div>
                    </div>
                    
                    <div class="debug-section">
                        <h3>الإشعارات في localStorage:</h3>
                        <div id="notificationsInfo">
                            <p>جاري تحميل الإشعارات...</p>
                        </div>
                    </div>
                    
                    <div class="debug-section">
                        <h3>حالة شارة الإشعارات:</h3>
                        <div id="badgeInfo">
                            <p>جاري فحص الشارة...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Actions -->
            <div class="test-actions-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-cogs"></i>
                        إجراءات الاختبار
                    </h2>
                </div>
                
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="setupCarOwner()">
                        <i class="fas fa-user-plus"></i>
                        إعداد مالك السيارة
                    </button>
                    
                    <button class="btn btn-success" onclick="createTestNotifications()">
                        <i class="fas fa-plus"></i>
                        إنشاء إشعارات تجريبية
                    </button>
                    
                    <button class="btn btn-info" onclick="testBadgeUpdate()">
                        <i class="fas fa-sync"></i>
                        اختبار تحديث الشارة
                    </button>
                    
                    <button class="btn btn-warning" onclick="clearNotifications()">
                        <i class="fas fa-trash"></i>
                        مسح جميع الإشعارات
                    </button>
                </div>
            </div>

            <!-- Console Output -->
            <div class="console-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-terminal"></i>
                        سجل التصحيح
                    </h2>
                </div>
                
                <div class="console-output" id="consoleOutput">
                    <p>سيظهر هنا سجل التصحيح...</p>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Global variables
        let debugLog = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 Initializing notification badge test page...');
            addLog('🔍 بدء اختبار شارة الإشعارات...');
            
            // Load debug information
            loadDebugInfo();
            
            // Update notification badge
            updateNotificationBadge();
            
            console.log('✅ Notification badge test page initialized');
            addLog('✅ تم تهيئة صفحة الاختبار');
        });

        // Load debug information
        function loadDebugInfo() {
            try {
                // User info
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const userType = localStorage.getItem('userType');
                const userToken = localStorage.getItem('userToken');
                
                const userInfoDiv = document.getElementById('userInfo');
                userInfoDiv.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>معرف المستخدم:</strong> ${userData.id || 'غير محدد'}
                        </div>
                        <div class="info-item">
                            <strong>اسم المستخدم:</strong> ${userData.full_name || 'غير محدد'}
                        </div>
                        <div class="info-item">
                            <strong>نوع المستخدم:</strong> ${userType || 'غير محدد'}
                        </div>
                        <div class="info-item">
                            <strong>الرمز المميز:</strong> ${userToken ? 'موجود' : 'غير موجود'}
                        </div>
                    </div>
                `;
                
                // Notifications info
                const mockNotifications = JSON.parse(localStorage.getItem('mockNotifications') || '[]');
                const notificationsInfoDiv = document.getElementById('notificationsInfo');
                notificationsInfoDiv.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>إجمالي الإشعارات:</strong> ${mockNotifications.length}
                        </div>
                        <div class="info-item">
                            <strong>الإشعارات غير المقروءة:</strong> ${mockNotifications.filter(n => !n.is_read).length}
                        </div>
                        <div class="info-item">
                            <strong>إشعارات المستخدم الحالي:</strong> ${mockNotifications.filter(n => n.user_id === userData.id).length}
                        </div>
                    </div>
                    <div class="notifications-list">
                        <h4>تفاصيل الإشعارات:</h4>
                        ${mockNotifications.length > 0 ? 
                            mockNotifications.map(n => `
                                <div class="notification-item">
                                    <strong>ID:</strong> ${n.id} | 
                                    <strong>المستخدم:</strong> ${n.user_id} | 
                                    <strong>النوع:</strong> ${n.type} | 
                                    <strong>مقروء:</strong> ${n.is_read ? 'نعم' : 'لا'}
                                </div>
                            `).join('') : 
                            '<p>لا توجد إشعارات</p>'
                        }
                    </div>
                `;
                
                // Badge info
                const badge = document.getElementById('notificationBadge');
                const badgeInfoDiv = document.getElementById('badgeInfo');
                badgeInfoDiv.innerHTML = `
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>عنصر الشارة:</strong> ${badge ? 'موجود' : 'غير موجود'}
                        </div>
                        <div class="info-item">
                            <strong>عرض الشارة:</strong> ${badge ? badge.style.display : 'غير محدد'}
                        </div>
                        <div class="info-item">
                            <strong>نص الشارة:</strong> ${badge ? badge.textContent : 'غير محدد'}
                        </div>
                    </div>
                `;
                
                addLog('📊 تم تحميل معلومات التصحيح');
                
            } catch (error) {
                console.error('❌ Error loading debug info:', error);
                addLog('❌ خطأ في تحميل معلومات التصحيح: ' + error.message);
            }
        }

        // Setup car owner
        function setupCarOwner() {
            try {
                console.log('👤 Setting up car owner...');
                addLog('👤 إعداد مالك السيارة...');
                
                const carOwnerData = {
                    id: 'test-owner',
                    full_name: 'مالك السيارة التجريبي',
                    email: 'owner@example.com',
                    user_type: 'owner'
                };
                
                // Store in localStorage
                localStorage.setItem('userData', JSON.stringify(carOwnerData));
                localStorage.setItem('userToken', 'owner-token-' + Date.now());
                localStorage.setItem('userType', 'owner');
                
                addLog('✅ تم إعداد مالك السيارة بنجاح');
                
                // Reload debug info
                loadDebugInfo();
                
                // Update notification badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('❌ Error setting up car owner:', error);
                addLog('❌ خطأ في إعداد مالك السيارة: ' + error.message);
            }
        }

        // Create test notifications
        function createTestNotifications() {
            try {
                console.log('🔔 Creating test notifications...');
                addLog('🔔 إنشاء إشعارات تجريبية...');
                
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (!userData.id) {
                    addLog('❌ يجب إعداد مالك السيارة أولاً');
                    return;
                }
                
                // Create test notifications
                const testNotifications = [
                    {
                        id: 'test-notification-1-' + Date.now(),
                        user_id: userData.id,
                        type: 'photo_uploaded',
                        title: 'تم رفع صور جديدة للحجز',
                        description: 'قام المستأجر برفع صور جديدة لحجز تويوتا كامري 2022',
                        related_id: '1',
                        related_type: 'booking',
                        is_read: false,
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 'test-notification-2-' + Date.now(),
                        user_id: userData.id,
                        type: 'photo_uploaded',
                        title: 'تم رفع صور جديدة للحجز',
                        description: 'قام المستأجر برفع صور جديدة لحجز هوندا سيفيك 2023',
                        related_id: '2',
                        related_type: 'booking',
                        is_read: false,
                        created_at: new Date(Date.now() - 3600000).toISOString()
                    }
                ];
                
                // Add to localStorage
                const existingNotifications = JSON.parse(localStorage.getItem('mockNotifications') || '[]');
                existingNotifications.push(...testNotifications);
                localStorage.setItem('mockNotifications', JSON.stringify(existingNotifications));
                
                addLog('✅ تم إنشاء إشعارات تجريبية بنجاح');
                
                // Reload debug info
                loadDebugInfo();
                
                // Update notification badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('❌ Error creating test notifications:', error);
                addLog('❌ خطأ في إنشاء الإشعارات التجريبية: ' + error.message);
            }
        }

        // Test badge update
        function testBadgeUpdate() {
            try {
                console.log('🔔 Testing badge update...');
                addLog('🔔 اختبار تحديث الشارة...');
                
                updateNotificationBadge();
                
                addLog('✅ تم اختبار تحديث الشارة');
                
            } catch (error) {
                console.error('❌ Error testing badge update:', error);
                addLog('❌ خطأ في اختبار تحديث الشارة: ' + error.message);
            }
        }

        // Clear notifications
        function clearNotifications() {
            try {
                console.log('🗑️ Clearing notifications...');
                addLog('🗑️ مسح جميع الإشعارات...');
                
                localStorage.removeItem('mockNotifications');
                
                addLog('✅ تم مسح جميع الإشعارات');
                
                // Reload debug info
                loadDebugInfo();
                
                // Update notification badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('❌ Error clearing notifications:', error);
                addLog('❌ خطأ في مسح الإشعارات: ' + error.message);
            }
        }

        // Update notification badge
        async function updateNotificationBadge() {
            try {
                addLog('🔔 تحديث شارة الإشعارات...');
                
                const token = localStorage.getItem('userToken');
                const response = await fetch('/api/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const badge = document.getElementById('notificationBadge');
                    
                    if (result.count > 0) {
                        badge.textContent = result.count;
                        badge.style.display = 'inline';
                        addLog('✅ تم تحديث الشارة من الخادم: ' + result.count);
                    } else {
                        badge.style.display = 'none';
                        addLog('✅ لا توجد إشعارات غير مقروءة');
                    }
                }
                
            } catch (error) {
                console.error('Error updating notification badge:', error);
                addLog('⚠️ خطأ في الاتصال بالخادم، استخدام الوضع التجريبي...');
                // In test mode, update badge from localStorage
                updateMockNotificationBadge();
            }
        }

        // Update mock notification badge for testing
        function updateMockNotificationBadge() {
            try {
                const mockNotifications = JSON.parse(localStorage.getItem('mockNotifications') || '[]');
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const currentUserId = userData.id || 'test-user';
                
                // Filter unread notifications for current user
                const unreadCount = mockNotifications.filter(n => 
                    n.user_id === currentUserId && !n.is_read
                ).length;
                
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'inline';
                        addLog('✅ تم تحديث الشارة التجريبية: ' + unreadCount);
                    } else {
                        badge.style.display = 'none';
                        addLog('✅ لا توجد إشعارات غير مقروءة للمستخدم الحالي');
                    }
                } else {
                    addLog('❌ عنصر الشارة غير موجود في الصفحة');
                }
                
            } catch (error) {
                console.error('❌ Error updating mock notification badge:', error);
                addLog('❌ خطأ في تحديث الشارة التجريبية: ' + error.message);
            }
        }

        // Add log message
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const logEntry = `[${timestamp}] ${message}`;
            
            debugLog.push(logEntry);
            console.log(logEntry);
            
            // Update console output
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = debugLog.map(log => `<div class="log-entry">${log}</div>`).join('');
            
            // Scroll to bottom
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
    </script>

    <style>
        .debug-card,
        .test-actions-card,
        .console-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #495057;
        }

        .debug-content,
        .test-actions {
            padding: 1.5rem;
        }

        .debug-section {
            margin-bottom: 1.5rem;
        }

        .debug-section h3 {
            margin-bottom: 1rem;
            color: #495057;
            font-size: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .notifications-list {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .test-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .console-output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 1rem;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-entry:last-child {
            margin-bottom: 0;
        }
    </style>
</body>
</html>
